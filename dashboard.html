<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¦–é  - ç¤¾å€ç®¡ç†ç³»çµ±</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{--primary-color:#1a1a1a;--secondary-color:#2d2d2d;--accent-color:#ffd700;--text-primary:#fff;--text-secondary:#b0b0b0}
    *{box-sizing:border-box}
    
    html,body{
      margin:0;
      height:100vh;
      overflow:hidden;
    }
    
    body{
      font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      color:var(--text-primary);
      display:flex;
    }
    
    .hidden{display:none!important}

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99;
      backdrop-filter: blur(4px);
    }
    
    .sidebar-overlay.active {
      display: block;
    }

    .sidebar{
      width:280px;
      background:rgba(45,45,45,.95);
      backdrop-filter:blur(8px);
      border-right:2px solid var(--accent-color);
      position:fixed;
      top:0;
      left:0;
      height:100vh;
      overflow-y:auto;
      overflow-x:hidden;
      padding:2rem 0;
      transition:.3s;
      z-index:100;
    }
    .sidebar.collapsed{transform:translateX(-100%)}
    .sidebar.open{transform:translateX(0)}
    .sidebar-header{padding:0 2rem 1.5rem;border-bottom:1px solid rgba(255,215,0,.3);margin-bottom:1.5rem}
    .sidebar-title{color:var(--accent-color);font-weight:700;font-size:1.3rem}
    .user-info{display:flex;gap:12px;align-items:center;margin-top:10px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--accent-color);color:#222;display:flex;align-items:center;justify-content:center;font-weight:800}
    .nav-menu{list-style:none;margin:0;padding:0}
    .nav-link{display:flex;gap:12px;align-items:center;padding:12px 20px;color:var(--text-primary);text-decoration:none;border-left:3px solid transparent;transition:.2s}
    .nav-link:hover,.nav-link.active{background:rgba(255,215,0,.1);border-left-color:var(--accent-color);color:var(--accent-color)}

    .main{
      margin-left:280px;
      width:calc(100% - 280px);
      height:100vh;
      display:flex;
      flex-direction:column;
      transition:all 0.3s ease;
    }
    .main.expanded{
      margin-left:0;
      width:100%;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 14px;
      background:var(--primary-color);
      border-bottom:1px solid rgba(255,215,0,.2);
      flex-shrink:0;
    }
    .page-title{display:flex;gap:8px;align-items:center;color:var(--accent-color);font-weight:700}
    .menu{cursor:pointer}
    .header-actions{display:flex;gap:8px}
    .header-actions button{display:flex;gap:6px;align-items:center;border:none;border-radius:8px;padding:8px 12px;background:var(--accent-color);color:#222;cursor:pointer;font-weight:600}
    .header-actions button:hover{filter:brightness(.95)}
    .content{
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      padding:16px;
    }

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .card{background:rgba(45,45,45,.85);border:1px solid rgba(255,215,0,.25);border-radius:14px;padding:14px}
    .stat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .stat-value{font-size:1.8rem;font-weight:800}
    .muted{color:var(--text-secondary)}
    .section-title{display:flex;gap:8px;align-items:center;color:var(--accent-color);margin-bottom:10px}

    .announcement-list{display:flex;flex-direction:column;gap:10px}
    .announcement-item{background:rgba(255,255,255,.06);border-left:4px solid var(--accent-color);border-radius:10px;padding:12px}
    .announcement-title{font-weight:700;margin-bottom:6px}
    .announcement-meta{display:flex;justify-content:space-between;color:var(--text-secondary);font-size:.9rem}

    .quick{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
    .action{background:rgba(45,45,45,.85);border:1px solid rgba(255,215,0,.25);border-radius:12px;padding:16px;text-align:center;cursor:pointer}

    /* Carousel styles for announcement rotation */
    .carousel-container{
      position:relative;
      width:100%;
      height:300px;
      overflow:hidden;
      border-radius:14px;
      margin-bottom:20px;
    }
    .carousel-slide{position:absolute;width:100%;height:100%;opacity:0;transition:opacity 0.8s ease-in-out;background-size:cover;background-position:center;display:flex;align-items:flex-end;padding:30px}
    .carousel-slide.active{opacity:1}
    .carousel-content{background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);padding:20px;border-radius:12px;width:100%}
    .carousel-title{font-size:1.8rem;font-weight:700;color:var(--accent-color);margin-bottom:10px}
    .carousel-text{color:var(--text-primary);margin-bottom:10px;line-height:1.6}
    /* Removed carousel navigation buttons */
    .carousel-indicators{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:10}
    .carousel-indicator{width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.5);cursor:pointer;transition:0.3s}
    .carousel-indicator.active{background:var(--accent-color);width:30px;border-radius:6px}

    /* Voting card styles */
    .vote-card{background:rgba(45,45,45,.85);border:1px solid rgba(255,215,0,.25);border-radius:14px;padding:16px;margin-bottom:12px}
    .vote-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .vote-title{font-size:1.2rem;font-weight:700;color:var(--accent-color)}
    .vote-status{padding:4px 12px;border-radius:20px;font-size:0.85rem;font-weight:600}
    .vote-status.open{background:rgba(76,175,80,0.2);color:#4caf50;border:1px solid #4caf50}
    .vote-status.closed{background:rgba(158,158,158,0.2);color:#9e9e9e;border:1px solid #9e9e9e}
    .vote-options{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .vote-option{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:10px;cursor:pointer;transition:0.3s;border:2px solid transparent}
    .vote-option:hover{background:rgba(255,215,0,0.1);border-color:var(--accent-color)}
    .vote-option.selected{background:rgba(255,215,0,0.15);border-color:var(--accent-color)}
    .vote-option input[type="radio"]{width:20px;height:20px;cursor:pointer}
    .vote-option-label{flex:1;font-weight:500}
    .vote-count{color:var(--text-secondary);font-size:0.9rem}
    .vote-btn{width:100%;padding:12px;background:var(--accent-color);color:#222;border:none;border-radius:10px;font-weight:700;cursor:pointer;margin-top:12px;transition:0.3s}
    .vote-btn:hover{filter:brightness(0.9)}
    .vote-btn:disabled{opacity:0.5;cursor:not-allowed}
    .vote-result-bar{height:8px;background:rgba(255,215,0,0.3);border-radius:4px;margin-top:6px;overflow:hidden}
    .vote-result-fill{height:100%;background:var(--accent-color);transition:width 0.5s ease}

    /* Maintenance form styles */
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-weight:600;color:var(--accent-color)}
    .form-input,.form-textarea,.form-select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,215,0,.25);background:rgba(255,255,255,.06);color:var(--text-primary);outline:none;font-family:inherit}
    .form-textarea{min-height:100px;resize:vertical}
    .form-input:focus,.form-textarea:focus,.form-select:focus{border-color:var(--accent-color);background:rgba(255,255,255,.08)}
    .file-upload{display:flex;align-items:center;gap:12px}
    .file-upload input[type="file"]{display:none}
    .file-upload-btn{padding:10px 16px;background:rgba(255,215,0,0.2);border:1px solid var(--accent-color);border-radius:10px;cursor:pointer;transition:0.3s;display:flex;align-items:center;gap:6px}
    .file-upload-btn:hover{background:rgba(255,215,0,0.3)}
    .file-preview{max-width:200px;max-height:200px;border-radius:10px;margin-top:10px}
    .submit-btn{width:100%;padding:14px;background:var(--accent-color);color:#222;border:none;border-radius:10px;font-weight:700;font-size:1.1rem;cursor:pointer;transition:0.3s}
    .submit-btn:hover{filter:brightness(.9)}

    /* Profile editor styles */
    .profile-card{background:rgba(45,45,45,.85);border:1px solid rgba(255,215,0,.25);border-radius:14px;padding:20px;max-width:600px;margin:0 auto}
    .profile-avatar-large{width:100px;height:100px;border-radius:50%;background:var(--accent-color);color:#222;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:2.5rem;margin:0 auto 20px}
    .profile-field{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:center;margin-bottom:16px}
    .profile-field-label{font-weight:600;color:var(--accent-color)}
    .profile-field-value{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,215,0,.25);background:rgba(255,255,255,.06);color:var(--text-primary)}
    .profile-actions{display:flex;gap:12px;margin-top:20px}
    .profile-btn{flex:1;padding:12px;border:none;border-radius:10px;font-weight:700;cursor:pointer;transition:0.3s}
    .profile-btn.primary{background:var(--accent-color);color:#222}
    .profile-btn.secondary{background:transparent;border:1px solid var(--accent-color);color:var(--text-primary)}
    .profile-btn:hover{filter:brightness(.9)}

    /* Package tracking styles */
    .package-list{display:flex;flex-direction:column;gap:12px}
    .package-item{background:rgba(255,255,255,.06);border-left:4px solid var(--accent-color);border-radius:10px;padding:14px;display:flex;justify-content:space-between;align-items:center}
    .package-info{flex:1}
    .package-status{padding:6px 14px;border-radius:20px;font-size:0.85rem;font-weight:600}
    .package-status.pending{background:rgba(255,193,7,0.2);color:#ffc107;border:1px solid #ffc107}
    .package-status.picked-up{background:rgba(76,175,80,0.2);color:#4caf50;border:1px solid #4caf50}

    /* AI Customer Service styles */
    .ai-chat-button{position:fixed;bottom:30px;right:30px;width:70px;height:70px;border-radius:16px;background:#FFD93D;border:3px solid #222;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,0.4);transition:0.3s;z-index:1000}
    .ai-chat-button:hover{transform:scale(1.1);box-shadow:0 6px 30px rgba(255,217,61,0.6)}
    /* Updated AI icon to be inline SVG robot */
    .ai-chat-button svg{width:40px;height:40px}
    .ai-chat-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:1001;backdrop-filter:blur(4px)}
    .ai-chat-modal.active{display:flex}
    .ai-chat-container{background:var(--secondary-color);border:2px solid var(--accent-color);border-radius:20px;width:90%;max-width:600px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 10px 50px rgba(0,0,0,0.5)}
    .ai-chat-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:2px solid rgba(255,215,0,0.3)}
    .ai-chat-title{font-size:1.3rem;font-weight:700;color:var(--accent-color);display:flex;align-items:center;gap:10px}
    .ai-chat-close{width:36px;height:36px;border-radius:50%;background:transparent;border:2px solid var(--accent-color);color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:0.3s}
    .ai-chat-close:hover{background:var(--accent-color);color:#222}
    .ai-chat-tabs{display:flex;gap:0;border-bottom:2px solid rgba(255,215,0,0.2);background:rgba(0,0,0,0.2)}
    .ai-chat-tab{flex:1;padding:14px;text-align:center;cursor:pointer;border-bottom:3px solid transparent;transition:0.3s;font-weight:600;color:var(--text-secondary)}
    .ai-chat-tab.active{color:var(--accent-color);border-bottom-color:var(--accent-color);background:rgba(255,215,0,0.05)}
    .ai-chat-tab:hover{background:rgba(255,215,0,0.08)}
    .ai-chat-content{flex:1;overflow-y:auto;padding:20px}
    .ai-function-list{display:flex;flex-direction:column;gap:12px}
    .ai-function-item{padding:14px;background:rgba(255,255,255,0.05);border-left:4px solid var(--accent-color);border-radius:10px;cursor:pointer;transition:0.3s}
    .ai-function-item:hover{background:rgba(255,215,0,0.1);transform:translateX(4px)}
    .ai-chat-messages{display:flex;flex-direction:column;gap:12px;min-height:300px}
    .ai-message{padding:12px 16px;border-radius:12px;max-width:80%;word-wrap:break-word}
    .ai-message.user{background:var(--accent-color);color:#222;align-self:flex-end;margin-left:auto}
    .ai-message.bot{background:rgba(255,255,255,0.08);color:var(--text-primary);align-self:flex-start}
    .ai-chat-input-area{display:flex;gap:10px;padding:16px;border-top:2px solid rgba(255,215,0,0.2);background:rgba(0,0,0,0.2)}
    .ai-chat-input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,215,0,0.3);background:rgba(255,255,255,0.06);color:var(--text-primary);outline:none}
    .ai-chat-input:focus{border-color:var(--accent-color);background:rgba(255,255,255,0.08)}
    .ai-chat-send{padding:12px 20px;background:var(--accent-color);color:#222;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:0.3s}
    .ai-chat-send:hover{filter:brightness(.9)}

    /* Enhanced responsive design for mobile and tablet */
    @media (max-width: 1024px) {
      .sidebar {
        width: 260px;
      }
      
      .main {
        margin-left: 260px;
        width: calc(100% - 260px);
      }
      
      .carousel-container {
        height: 280px;
      }
      
      .stats {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }

    @media (max-width:768px){
      .main{margin-left:0;width:100%}
      .sidebar{
        transform:translateX(-100%);
        width:75vw;
        max-width:320px;
      }
      .sidebar.open{
        transform:translateX(0);
        box-shadow:4px 0 20px rgba(0,0,0,0.5);
      }
      
      header {
        position:sticky;
        top:0;
        z-index:20;
        padding:12px 10px;
      }
      
      .page-title {
        font-size: 1.1rem;
      }
      
      .header-actions {
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .header-actions button {
        padding: 6px 10px;
        font-size: 0.85rem;
      }
      
      .header-actions button .material-icons {
        font-size: 18px;
      }
      
      .content {
        padding: 12px;
      }
      
      .carousel-container{
        height:250px;
        border-radius:10px;
      }
      .carousel-content {
        padding: 15px;
      }
      
      .carousel-title {
        font-size: 1.3rem;
      }
      
      .carousel-text {
        font-size: 0.9rem;
      }
      
      .stats {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .card {
        padding: 12px;
      }
      
      .section-title {
        font-size: 1.2rem;
      }
      
      .profile-field{grid-template-columns:1fr;gap:6px}
      .profile-avatar-large {
        width: 80px;
        height: 80px;
        font-size: 2rem;
      }
      
      .ai-chat-container{width:95%;max-height:90vh}
      .ai-chat-button{bottom:20px;right:20px;width:60px;height:60px}
      .ai-chat-button svg {
        width: 32px;
        height: 32px;
      }
      
      .quick {
        grid-template-columns: 1fr;
      }
      
      .emergency-action {
        padding: 14px;
      }
      
      .vote-card {
        padding: 14px;
      }
      
      .form-group {
        margin-bottom: 14px;
      }
      
      .announcement-item {
        padding: 10px;
      }
    }

    @media (max-width: 480px) {
      .sidebar {
        width: 85vw;
        max-width: none;
      }
      
      .header-actions button span:not(.material-icons) {
        display: none;
      }
      
      .carousel-container {
        height: 220px;
      }
      
      .carousel-title {
        font-size: 1.1rem;
      }
      
      .carousel-text {
        font-size: 0.85rem;
        line-height: 1.4;
      }
      
      .ai-chat-button {
        width: 55px;
        height: 55px;
        bottom: 15px;
        right: 15px;
      }
      
      .ai-chat-button svg {
        width: 28px;
        height: 28px;
      }
      
      .ai-chat-title {
        font-size: 1.1rem;
      }
      
      .ai-chat-tab {
        padding: 10px;
        font-size: 0.85rem;
      }
    }

    .emergency-action {
      background: rgba(45,45,45,.85);
      border: 2px solid #f44336;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      font-weight: bold;
      color: #f44336;
    }
    .emergency-action:hover {
      background: rgba(244,67,54,0.2);
    }
  </style>
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">ç¤¾å€ç®¡ç†ç³»çµ±</div>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <div>
          <div id="userName">è¼‰å…¥ä¸­...</div>
          <div id="userRole" class="muted">ä½æˆ¶</div>
        </div>
      </div>
    </div>
    <ul class="nav-menu" id="navMenu">
      <li><a href="#" class="nav-link active" data-section="dashboard"><span class="material-icons">dashboard</span> é¦–é </a></li>
      <li><a href="#" class="nav-link" data-section="profile"><span class="material-icons">person</span> å€‹äººè³‡æ–™</a></li>
      <li><a href="#" class="nav-link" data-section="packages"><span class="material-icons">inventory_2</span> æˆ‘çš„åŒ…è£¹</a></li>
      <li><a href="#" class="nav-link" data-section="voting"><span class="material-icons">how_to_vote</span> ç¤¾å€æŠ•ç¥¨</a></li>
      <li><a href="#" class="nav-link" data-section="maintenance"><span class="material-icons">build</span> è¨­å‚™/ç¶­è­·</a></li>
      <li><a href="#" class="nav-link" data-section="finance"><span class="material-icons">account_balance</span> ç®¡ç†è²»/æ”¶æ”¯</a></li>
      <li><a href="#" class="nav-link" data-section="visitors"><span class="material-icons">how_to_reg</span> è¨ªå®¢ç´€éŒ„</a></li>
      <li><a href="#" class="nav-link" data-section="meetings"><span class="material-icons">event</span> æœƒè­°/æ´»å‹•</a></li>
      <li><a href="#" class="nav-link" data-section="emergencies"><span class="material-icons">emergency</span> ç·Šæ€¥äº‹ä»¶</a></li>
    </ul>
  </nav>

  <main class="main" id="main">
    <header>
      <div class="page-title">
        <span class="material-icons menu" onclick="toggleSidebar()">menu</span>
        <span id="pageTitle">é¦–é </span>
      </div>
      <div class="header-actions">
        <button onclick="window.location.href='admin.html'"><span class="material-icons">admin_panel_settings</span> é€²å…¥å¾Œå°</button>
        <button onclick="logout()"><span class="material-icons">logout</span> ç™»å‡º</button>
      </div>
    </header>

    <div class="content">
      <section id="dashboardSection">
        <!-- Carousel for announcements -->
        <div class="carousel-container" id="announcementCarousel">
          <div class="muted" style="display:flex;align-items:center;justify-content:center;height:100%">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2 class="section-title"><span class="material-icons">emergency</span> 
            <span style="color:#f44336;font-weight:bold">ç·Šæ€¥äº‹ä»¶</span>
          </h2>
          <div class="quick">
            <div class="emergency-action" onclick="confirmEmergency('æ•‘è­·è»Š119','é†«ç™‚ç·Šæ€¥ç‹€æ³')">
              <div class="material-icons" style="color:#f44336;">local_hospital</div>
              <h3 style="color:#f44336;font-weight:bold">æ•‘è­·è»Š 119</h3>
            </div>
            <div class="emergency-action" onclick="confirmEmergency('å ±è­¦110','æ²»å®‰ç·Šæ€¥ç‹€æ³')">
              <div class="material-icons" style="color:#f44336;">report_problem</div>
              <h3 style="color:#f44336;font-weight:bold">å ±è­¦ 110</h3>
            </div>
            <div class="emergency-action" onclick="confirmEmergency('AED','éœ€è¦AEDæ€¥æ•‘è¨­å‚™')">
              <div class="material-icons" style="color:#f44336;">favorite</div>
              <h3 style="color:#f44336;font-weight:bold">AED</h3>
            </div>
            <div class="emergency-action" onclick="confirmEmergency('å¯ç–‘äººå“¡','é™Œç”Ÿäººå“¡é—–å…¥è­¦å‘Š')">
              <div class="material-icons" style="color:#f44336;">warning</div>
              <h3 style="color:#f44336;font-weight:bold">é™Œç”Ÿäººå“¡é—–å…¥</h3>
            </div>
          </div>
        </div>
      </section>

      <section id="dynamicContent" class="hidden"></section>
    </div>
  </main>

  <!-- AI Customer Service Button and Modal -->
  <div class="ai-chat-button" onclick="toggleAIChat()">
     <!-- Replaced image with inline SVG robot icon -->
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="7" y="5" width="10" height="12" rx="2" fill="#222"/>
      <circle cx="10" cy="9" r="1.5" fill="#FFD93D"/>
      <circle cx="14" cy="9" r="1.5" fill="#FFD93D"/>
      <rect x="9" y="12" width="6" height="1.5" rx="0.75" fill="#FFD93D"/>
      <rect x="5" y="9" width="2" height="4" rx="1" fill="#222"/>
      <rect x="17" y="9" width="2" height="4" rx="1" fill="#222"/>
      <circle cx="12" cy="4" r="1.5" fill="#222"/>
      <rect x="8" y="17" width="2" height="3" rx="1" fill="#222"/>
      <rect x="14" y="17" width="2" height="3" rx="1" fill="#222"/>
    </svg>
  </div>

  <div class="ai-chat-modal" id="aiChatModal">
    <div class="ai-chat-container">
      <div class="ai-chat-header">
        <div class="ai-chat-title">
           <!-- Updated AI icon in modal header -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:32px;height:32px">
            <rect x="7" y="5" width="10" height="12" rx="2" fill="#222"/>
            <circle cx="10" cy="9" r="1.5" fill="#FFD93D"/>
            <circle cx="14" cy="9" r="1.5" fill="#FFD93D"/>
            <rect x="9" y="12" width="6" height="1.5" rx="0.75" fill="#FFD93D"/>
            <rect x="5" y="9" width="2" height="4" rx="1" fill="#222"/>
            <rect x="17" y="9" width="2" height="4" rx="1" fill="#222"/>
            <circle cx="12" cy="4" r="1.5" fill="#222"/>
            <rect x="8" y="17" width="2" height="3" rx="1" fill="#222"/>
            <rect x="14" y="17" width="2" height="3" rx="1" fill="#222"/>
          </svg>
          AI å®¢æœï¼ˆç¤¾å€åŠŸèƒ½å¿«æ·ï¼‰
        </div>
        <button class="ai-chat-close" onclick="toggleAIChat()">âœ•</button>
      </div>
      <div class="ai-chat-tabs">
        <div class="ai-chat-tab active" data-tab="functions" onclick="switchAITab('functions')">å¸¸ç”¨åŠŸèƒ½</div>
        <div class="ai-chat-tab" data-tab="resident" onclick="switchAITab('resident')">ä½æˆ¶æœå‹™</div>
        <div class="ai-chat-tab" data-tab="emergency" onclick="switchAITab('emergency')">ç·Šæ€¥æœå‹™</div>
      </div>
      <div class="ai-chat-content">
        <div id="aiTabFunctions" class="ai-function-list">
          <div class="ai-function-item" onclick="navigateToSection('voting')">ğŸ“¢ æŠ•ç¥¨</div>
          <div class="ai-function-item" onclick="navigateToSection('maintenance')">ğŸ”§ ç¶­ä¿® / å®¢æœ</div>
          <div class="ai-function-item" onclick="navigateToSection('finance')">ğŸ’° å¸³å‹™ / æ”¶è²»</div>
          <div class="ai-function-item" onclick="navigateToSection('profile')">ğŸ‘¤ ä½æˆ¶ / äººå“¡</div>
          <div class="ai-function-item" onclick="navigateToSection('packages')">ğŸ“¦ è¨ªå®¢ / åŒ…è£¹</div>
        </div>
        <div id="aiTabResident" class="ai-chat-messages hidden">
          <div class="ai-message bot">æ‚¨å¥½ï¼æˆ‘æ˜¯ç¤¾å€ AI åŠ©ç†ã€‚è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«åŠ©æ‚¨çš„å—ï¼Ÿ</div>
          <div class="muted" style="text-align:center;padding:20px">
            æç¤ºï¼šæ‚¨å¯ä»¥è©¢å•é—œæ–¼å…¬å‘Šã€ç¶­ä¿®ã€ç¹³è²»ã€åŒ…è£¹ç­‰å•é¡Œ
          </div>
        </div>
        <div id="aiTabEmergency" class="ai-function-list hidden">
          <div class="ai-function-item" onclick="confirmEmergency('æ•‘è­·è»Š119','é†«ç™‚ç·Šæ€¥ç‹€æ³');toggleAIChat()">ğŸš‘ æ•‘è­·è»Š 119</div>
          <div class="ai-function-item" onclick="confirmEmergency('å ±è­¦110','æ²»å®‰ç·Šæ€¥ç‹€æ³');toggleAIChat()">ğŸš¨ å ±è­¦ 110</div>
          <div class="ai-function-item" onclick="confirmEmergency('AED','éœ€è¦AEDæ€¥æ•‘è¨­å‚™');toggleAIChat()">â¤ï¸ AED æ€¥æ•‘</div>
          <div class="ai-function-item" onclick="confirmEmergency('å¯ç–‘äººå“¡','é™Œç”Ÿäººå“¡é—–å…¥è­¦å‘Š');toggleAIChat()">âš ï¸ é™Œç”Ÿäººå“¡é—–å…¥</div>
        </div>
      </div>
      <div class="ai-chat-input-area" id="aiChatInputArea" style="display:none">
        <input type="text" class="ai-chat-input" id="aiChatInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..." onkeypress="if(event.key==='Enter')sendAIMessage()">
        <button class="ai-chat-send" onclick="sendAIMessage()">â–¶</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://oyydhfvgtmghvnbkvczr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95eWRoZnZndG1naHZuYmt2Y3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1OTMwMTIsImV4cCI6MjA3MzE2OTAxMn0.fgz_Vl7bZ1rtrttOAQcTlymMgHfhiY2NDo3qEnBT1og";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser=null, currentSection='dashboard';
    let carouselInterval = null;
    let currentSlide = 0;

    document.addEventListener('DOMContentLoaded',()=>{
      initAuth();
      bindNav();
    });

    function toggleSidebar(){
      const sb=document.getElementById('sidebar');
      const main=document.getElementById('main');
      const overlay=document.getElementById('sidebarOverlay');
      
      if (window.innerWidth<=768) {
        sb.classList.toggle('open');
        overlay.classList.toggle('active');
        /* Prevent body scroll when sidebar is open */
        if (sb.classList.contains('open')) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      } else {
        sb.classList.toggle('collapsed');
        main.classList.toggle('expanded');
      }
    }

    function bindNav(){
      document.querySelectorAll('.nav-link').forEach(a=>{
        a.addEventListener('click',(e)=>{
          e.preventDefault();
          const sec=a.dataset.section;
          switchSection(sec);
        });
      });
      document.querySelectorAll('.action').forEach(x=>{
        x.addEventListener('click',()=>switchSection(x.dataset.section));
      });
    }

    function switchSection(section){
      document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
      const active = document.querySelector(`.nav-link[data-section="${section}"]`);
      if (active) active.classList.add('active');

      const titles={
        dashboard:'é¦–é ',
        voting:'æŠ•ç¥¨',
        maintenance:'è¨­å‚™/ç¶­è­·',
        finance:'ç®¡ç†è²»/æ”¶æ”¯',
        profile:'å€‹äººè³‡æ–™',
        packages:'æˆ‘çš„åŒ…è£¹',
        visitors:'è¨ªå®¢ç´€éŒ„',
        meetings:'æœƒè­°/æ´»å‹•',
        emergencies:'ç·Šæ€¥'
      };
      document.getElementById('pageTitle').textContent = titles[section] || 'é¦–é ';

      const dash = document.getElementById('dashboardSection');
      const dyn  = document.getElementById('dynamicContent');
      if (section==='dashboard'){ 
        dash.classList.remove('hidden'); 
        dyn.classList.add('hidden'); 
        currentSection='dashboard';
        loadCarousel();
        return; 
      }

      dash.classList.add('hidden'); 
      dyn.classList.remove('hidden'); 
      currentSection=section;
      if (carouselInterval) {
        clearInterval(carouselInterval);
        carouselInterval = null;
      }
      loadSection(section);
    }

    async function initAuth(){
      const storedUser = localStorage.getItem('currentUser');
      if (!storedUser){ window.location.href='auth.html'; return; }
      try{
        currentUser = JSON.parse(storedUser);
        document.getElementById('userName').textContent = currentUser.name || 'æœªçŸ¥ç”¨æˆ¶';
        document.getElementById('userRole').textContent = ({resident:'ä½æˆ¶',committee:'å§”å“¡æœƒ',vendor:'å» å•†',admin:'ç®¡ç†å“¡'})[currentUser.role] || 'ä½æˆ¶';
        document.getElementById('userAvatar').textContent = (currentUser.name||'U').charAt(0).toUpperCase();
        await loadCarousel();
      }catch(e){ localStorage.removeItem('currentUser'); window.location.href='auth.html'; }
    }

    async function loadCarousel(){
      if (carouselInterval) clearInterval(carouselInterval);
      
      try{
        const { data, error } = await supabase
          .from('announcements')
          .select('id,title,content,image_url,author,created_at')
          .eq('status','published')
          .order('created_at',{ascending:false})
          .limit(5);
        
        if (error) throw error;
        
        const container = document.getElementById('announcementCarousel');
        if (!data || !data.length){ 
          container.innerHTML='<div class="muted" style="display:flex;align-items:center;justify-content:center;height:100%">æš«ç„¡å…¬å‘Š</div>'; 
          return; 
        }

        container.innerHTML = data.map((a, idx)=>`
          <div class="carousel-slide ${idx===0?'active':''}" style="background-image:url('${a.image_url || '/placeholder.svg?height=400&width=1200'}')">
            <div class="carousel-content">
              <div class="carousel-title">${a.title||''}</div>
              <div class="carousel-text">${(a.content||'').slice(0,200)}${(a.content||'').length>200?'...':''}</div>
              <div class="muted">ç™¼å¸ƒè€…: ${a.author||'ç³»çµ±'} | ${new Date(a.created_at).toLocaleDateString('zh-TW')}</div>
            </div>
          </div>
        `).join('') + `
          <div class="carousel-indicators">
            ${data.map((_, idx)=>`<div class="carousel-indicator ${idx===0?'active':''}" onclick="goToSlide(${idx})"></div>`).join('')}
          </div>
        `;
        /* Removed carousel navigation buttons from HTML */

        currentSlide = 0;
        carouselInterval = setInterval(nextSlide, 5000);
      }catch(e){
        console.error(e);
        document.getElementById('announcementCarousel').innerHTML = '<div class="muted" style="display:flex;align-items:center;justify-content:center;height:100%">å…¬å‘Šè¼‰å…¥å¤±æ•—</div>';
      }
    }

    function nextSlide(){
      const slides = document.querySelectorAll('.carousel-slide');
      const indicators = document.querySelectorAll('.carousel-indicator');
      if (!slides.length) return;
      
      slides[currentSlide].classList.remove('active');
      indicators[currentSlide].classList.remove('active');
      currentSlide = (currentSlide + 1) % slides.length;
      slides[currentSlide].classList.add('active');
      indicators[currentSlide].classList.add('active');
    }

    function prevSlide(){
      const slides = document.querySelectorAll('.carousel-slide');
      const indicators = document.querySelectorAll('.carousel-indicator');
      if (!slides.length) return;
      
      slides[currentSlide].classList.remove('active');
      indicators[currentSlide].classList.remove('active');
      currentSlide = (currentSlide - 1 + slides.length) % slides.length;
      slides[currentSlide].classList.add('active');
      indicators[currentSlide].classList.add('active');
    }

    function goToSlide(index){
      const slides = document.querySelectorAll('.carousel-slide');
      const indicators = document.querySelectorAll('.carousel-indicator');
      if (!slides.length) return;
      
      slides[currentSlide].classList.remove('active');
      indicators[currentSlide].classList.remove('active');
      currentSlide = index;
      slides[currentSlide].classList.add('active');
      indicators[currentSlide].classList.add('active');
    }

    function loadSection(section){
      const meta = {
        voting:['how_to_vote','æŠ•ç¥¨'],
        maintenance:['build','ç¶­ä¿®ç”³è«‹'],
        finance:['account_balance','è²¡å‹™ç®¡ç†'],
        profile:['person','å€‹äººè³‡æ–™'],
        packages:['inventory_2','æˆ‘çš„åŒ…è£¹'],
        visitors:['how_to_reg','è¨ªå®¢ç®¡ç†'],
        meetings:['event','æœƒè­°ç®¡ç†'],
        emergencies:['emergency','ç·Šæ€¥æœå‹™']
      }[section] || ['dashboard','åŠŸèƒ½'];
      
      const dyn = document.getElementById('dynamicContent');
      dyn.innerHTML = `
        <div class="card">
          <h2 class="section-title"><span class="material-icons">${meta[0]}</span>${meta[1]}</h2>
          <div id="${section}Section"><div class="muted">è¼‰å…¥ä¸­...</div></div>
        </div>`;

      switch(section){
        case 'voting': loadVotingOnly(); break;
        case 'maintenance': loadMaintenanceForm(); break;
        case 'finance': loadFinance(); break;
        case 'profile': loadProfile(); break;
        case 'packages': loadPackages(); break;
        case 'visitors': loadVisitors(); break;
        case 'meetings': loadMeetings(); break;
        case 'emergencies': loadEmergencies(); break;
        default: document.getElementById(section+'Section').innerHTML='<div class="muted">æ­¤åŠŸèƒ½å°šæœªå¯¦ä½œ</div>';
      }
    }

    async function loadVotingOnly(){
      const el=document.getElementById('votingSection');
      try{
        const { data: votes, error } = await supabase
          .from('votes')
          .select('*')
          .order('created_at',{ascending:false})
          .limit(20);
        
        if (error) throw error;
        
        el.innerHTML = (votes||[]).map(v => renderVoteCard(v)).join('') || '<div class="muted">æš«ç„¡æŠ•ç¥¨</div>';

        // Bind vote buttons
        (votes||[]).forEach(v => {
          const btn = document.getElementById(`vote-btn-${v.id}`);
          if (btn) btn.onclick = () => submitVote(v.id);
          loadVoteResults(v.id);
        });
      }catch(e){ 
        console.error(e); 
        el.innerHTML='<div class="muted">è¼‰å…¥å¤±æ•—: ' + e.message + '</div>'; 
      }
    }


    function renderVoteCard(vote){
      const options = Array.isArray(vote.options) ? vote.options : JSON.parse(vote.options || '[]');
      const isClosed = vote.status === 'closed';
      
      return `
        <div class="vote-card" id="vote-card-${vote.id}">
          <div class="vote-header">
            <div class="vote-title">${vote.title}</div>
            <div class="vote-status ${isClosed?'closed':'open'}">${isClosed?'å·²çµæŸ':'é€²è¡Œä¸­'}</div>
          </div>
          <div class="muted" style="margin-bottom:12px">${vote.description||''}</div>
          <div class="vote-options" id="vote-options-${vote.id}">
            ${options.map((opt, idx) => `
              <div class="vote-option" data-option="${opt}">
                ${!isClosed ? `<input type="radio" name="vote-${vote.id}" value="${opt}">` : ''}
                <div class="vote-option-label">${opt}</div>
                <div class="vote-count" id="vote-count-${vote.id}-${idx}">è¼‰å…¥ä¸­...</div>
              </div>
              <div class="vote-result-bar"><div class="vote-result-fill" id="vote-fill-${vote.id}-${idx}" style="width:0%"></div></div>
            `).join('')}
          </div>
          ${!isClosed ? `<button class="vote-btn" id="vote-btn-${vote.id}">é€å‡ºæŠ•ç¥¨</button>` : ''}
          <div class="muted" id="vote-status-${vote.id}" style="margin-top:12px;text-align:center"></div>
          <div class="muted" style="margin-top:8px;font-size:0.85rem">
            ç™¼å¸ƒè€…: ${vote.author||'ç³»çµ±'} | ${new Date(vote.created_at).toLocaleDateString('zh-TW')}
            ${vote.ends_at ? ` | æˆªæ­¢: ${new Date(vote.ends_at).toLocaleDateString('zh-TW')}` : ''}
          </div>
        </div>
      `;
    }

    async function loadVoteResults(voteId){
      try{
        const { data: records, error } = await supabase
          .from('vote_records')
          .select('option_selected, user_id')
          .eq('vote_id', voteId);
        
        if (error) throw error;

        const { data: vote } = await supabase
          .from('votes')
          .select('options')
          .eq('id', voteId)
          .single();
        
        const options = Array.isArray(vote?.options) ? vote.options : JSON.parse(vote?.options || '[]');
        const voteCounts = {};
        options.forEach(opt => voteCounts[opt] = 0);
        
        let userVoted = false;
        let userOption = null;
        
        (records||[]).forEach(r => {
          voteCounts[r.option_selected] = (voteCounts[r.option_selected] || 0) + 1;
          if (currentUser && r.user_id === currentUser.id) {
            userVoted = true;
            userOption = r.option_selected;
          }
        });
        
        const totalVotes = Object.values(voteCounts).reduce((sum, count) => sum + count, 0);
        
        options.forEach((opt, idx) => {
          const count = voteCounts[opt] || 0;
          const percentage = totalVotes > 0 ? (count / totalVotes * 100).toFixed(1) : 0;
          const countEl = document.getElementById(`vote-count-${voteId}-${idx}`);
          const fillEl = document.getElementById(`vote-fill-${voteId}-${idx}`);
          if (countEl) countEl.textContent = `${count} ç¥¨ (${percentage}%)`;
          if (fillEl) fillEl.style.width = `${percentage}%`;
        });
        
        const statusEl = document.getElementById(`vote-status-${voteId}`);
        if (statusEl && userVoted) {
          statusEl.textContent = `âœ“ æ‚¨å·²æŠ•ç¥¨çµ¦: ${userOption}`;
          const btn = document.getElementById(`vote-btn-${voteId}`);
          if (btn) btn.style.display = 'none';
        }
        
        return userVoted;
      }catch(e){
        console.error(e);
      }
    }

    function selectVoteOption(voteId, option){
      const radio = document.querySelector(`input[name="vote-${voteId}"][value="${option}"]`);
      if (radio) radio.checked = true;
    }

    async function submitVote(voteId){
      if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
      
      const selectedOption = document.querySelector(`input[name="vote-${voteId}"]:checked`);
      if (!selectedOption) { alert('è«‹é¸æ“‡ä¸€å€‹é¸é …'); return; }

      try{
        const { error } = await supabase
          .from('vote_records')
          .insert({
            vote_id: voteId,
            user_id: currentUser.id,
            user_name: currentUser.name,
            option_selected: selectedOption.value
          });

        if (error) {
          if (error.code === '23505') { // Unique constraint violation
            alert('æ‚¨å·²ç¶“æŠ•éç¥¨äº†');
          } else {
            throw error;
          }
          return;
        }

        alert('æŠ•ç¥¨æˆåŠŸ!');
        await loadVoteResults(voteId);
      }catch(e){
        console.error(e);
        alert('æŠ•ç¥¨å¤±æ•—: ' + e.message);
      }
    }

    async function loadMaintenanceForm(){
      const el=document.getElementById('maintenanceSection');
      el.innerHTML = `
        <form id="maintenanceForm" onsubmit="submitMaintenance(event)">
          <div class="form-group">
            <label class="form-label">è¨­å‚™åç¨±</label>
            <input type="text" class="form-input" id="equipment" required placeholder="ä¾‹: é›»æ¢¯ã€æ°´ç®¡ã€é–€ç¦">
          </div>
          <div class="form-group">
            <label class="form-label">å•é¡Œé …ç›®</label>
            <input type="text" class="form-input" id="item" required placeholder="ä¾‹: æ•…éšœã€æ¼æ°´ã€æå£">
          </div>
          <div class="form-group">
            <label class="form-label">è©³ç´°æè¿°</label>
            <textarea class="form-textarea" id="description" required placeholder="è«‹è©³ç´°æè¿°å•é¡Œç‹€æ³..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">ä¸Šå‚³ç…§ç‰‡ (é¸å¡«)</label>
            <div class="file-upload">
              <label for="photoUpload" class="file-upload-btn">
                <span class="material-icons">add_photo_alternate</span>
                <span id="fileName">é¸æ“‡ç…§ç‰‡</span>
              </label>
              <input type="file" id="photoUpload" accept="image/*" onchange="previewPhoto(event)">
            </div>
            <img id="photoPreview" class="file-preview hidden" alt="ç…§ç‰‡é è¦½">
          </div>
          <button type="submit" class="submit-btn">é€å‡ºç¶­ä¿®ç”³è«‹</button>
        </form>

        <h3 style="color:var(--accent-color);margin:24px 0 12px">æˆ‘çš„ç¶­ä¿®ç”³è«‹</h3>
        <div id="myMaintenanceList"><div class="muted">è¼‰å…¥ä¸­...</div></div>
      `;

      loadMyMaintenance();
    }

    function previewPhoto(event){
      const file = event.target.files[0];
      const preview = document.getElementById('photoPreview');
      const fileName = document.getElementById('fileName');
      
      if (file) {
        fileName.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    async function submitMaintenance(event){
      event.preventDefault();
      if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }

      const equipment = document.getElementById('equipment').value;
      const item = document.getElementById('item').value;
      const description = document.getElementById('description').value;
      const photoFile = document.getElementById('photoUpload').files[0];

      try{
        let photoUrl = null;
        if (photoFile) {
          // Convert to base64 for demo (in production, use proper file storage)
          const reader = new FileReader();
          photoUrl = await new Promise((resolve) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(photoFile);
          });
        }

        const { error } = await supabase
          .from('maintenance')
          .insert({
            equipment,
            item,
            description,
            photo_url: photoUrl,
            reported_by: currentUser.name,
            status: 'open',
            handler: '',
            assignee: '',
            cost: 0
          });

        if (error) throw error;

        alert('ç¶­ä¿®ç”³è«‹å·²é€å‡º!');
        document.getElementById('maintenanceForm').reset();
        document.getElementById('photoPreview').classList.add('hidden');
        document.getElementById('fileName').textContent = 'é¸æ“‡ç…§ç‰‡';
        loadMyMaintenance();
      }catch(e){
        console.error(e);
        alert('é€å‡ºå¤±æ•—: ' + e.message);
      }
    }

    async function loadMyMaintenance(){
      const el = document.getElementById('myMaintenanceList');
      if (!el) return;
      
      try{
        /* Load ALL maintenance records, not just current user's */
        const { data, error } = await supabase
          .from('maintenance')
          .select('*')
          .order('created_at', {ascending:false});

        if (error) throw error;

        el.innerHTML = (data||[]).map(m=>`
          <div class="announcement-item">
            <div class="announcement-title">${m.equipment} - ${m.item}</div>
            <div class="muted">${m.description||''}</div>
            ${m.photo_url ? `<img src="${m.photo_url}" style="max-width:200px;border-radius:8px;margin-top:8px" alt="ç¶­ä¿®ç…§ç‰‡">` : ''}
            <div class="announcement-meta">
              <span>å ±ä¿®äºº: ${m.reported_by||'æœªçŸ¥'}</span>
              <span>ç‹€æ…‹: ${m.status}</span>
              <span>è™•ç†äºº: ${m.handler||'æœªæŒ‡æ´¾'}</span>
              <span>${new Date(m.created_at).toLocaleDateString('zh-TW')}</span>
            </div>
          </div>
        `).join('') || '<div class="muted">æš«ç„¡ç¶­ä¿®ç”³è«‹</div>';
      }catch(e){
        console.error(e);
        el.innerHTML = '<div class="muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function loadProfile(){
      const el=document.getElementById('profileSection');
      if (!currentUser) { el.innerHTML='<div class="muted">è«‹å…ˆç™»å…¥</div>'; return; }

      try{
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        if (error) throw error;

        el.innerHTML = `
          <div class="profile-card">
            <div class="profile-avatar-large">${(data.name||'U').charAt(0).toUpperCase()}</div>
            <div class="profile-field">
              <div class="profile-field-label">å§“å</div>
              <input type="text" class="profile-field-value" id="profileName" value="${data.name||''}">
            </div>
            <div class="profile-field">
              <div class="profile-field-label">æˆ¿è™Ÿ</div>
              <input type="text" class="profile-field-value" id="profileRoom" value="${data.room||''}">
            </div>
            <div class="profile-field">
              <div class="profile-field-label">é›»è©±</div>
              <input type="text" class="profile-field-value" id="profilePhone" value="${data.phone||''}">
            </div>
            <div class="profile-field">
              <div class="profile-field-label">Email</div>
              <input type="email" class="profile-field-value" id="profileEmail" value="${data.email||''}">
            </div>
            <div class="profile-field">
              <div class="profile-field-label">å¯†ç¢¼</div>
              <input type="password" class="profile-field-value" id="profilePassword" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹">
            </div>
            <div class="profile-field">
              <div class="profile-field-label">èº«åˆ†</div>
              <div class="profile-field-value" style="background:rgba(255,255,255,0.02);cursor:not-allowed">${data.role||'resident'}</div>
            </div>
            <div class="profile-actions">
              <button class="profile-btn primary" onclick="saveProfile()">å„²å­˜è®Šæ›´</button>
              <button class="profile-btn secondary" onclick="loadProfile()">å–æ¶ˆ</button>
            </div>
          </div>
        `;
      }catch(e){
        console.error(e);
        el.innerHTML = '<div class="muted">è¼‰å…¥å¤±æ•—: ' + e.message + '</div>';
      }
    }

    async function saveProfile(){
      if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }

      const name = document.getElementById('profileName').value;
      const room = document.getElementById('profileRoom').value;
      const phone = document.getElementById('profilePhone').value;
      const email = document.getElementById('profileEmail').value;
      const password = document.getElementById('profilePassword').value;

      try{
        const updates = { name, room, phone, email };
        if (password) updates.password = password;

        const { error } = await supabase
          .from('profiles')
          .update(updates)
          .eq('id', currentUser.id);

        if (error) throw error;

        // Update local storage
        currentUser.name = name;
        currentUser.room = room;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));

        alert('å€‹äººè³‡æ–™å·²æ›´æ–°!');
        document.getElementById('userName').textContent = name;
        document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
      }catch(e){
        console.error(e);
        alert('æ›´æ–°å¤±æ•—: ' + e.message);
      }
    }

    async function loadPackages(){
      const el=document.getElementById('packagesSection');
      if (!currentUser) { el.innerHTML='<div class="muted">è«‹å…ˆç™»å…¥</div>'; return; }

      try{
        const { data, error } = await supabase
          .from('packages')
          .select('*')
          .eq('recipient_room', currentUser.room)
          .order('arrived_at', {ascending:false})
          .limit(20);

        if (error) throw error;

        el.innerHTML = `
          <div class="package-list">
            ${(data||[]).map(p=>`
              <div class="package-item">
                <div class="package-info">
                  <div style="font-weight:700;margin-bottom:4px">${p.courier||'åŒ…è£¹'} ${p.tracking_number?`(${p.tracking_number})`:''}</div>
                  <div class="muted">æ”¶ä»¶äºº: ${p.recipient_name} | åˆ°é”æ™‚é–“: ${new Date(p.arrived_at).toLocaleString('zh-TW')}</div>
                  ${p.picked_up_at ? `<div class="muted">é ˜å–æ™‚é–“: ${new Date(p.picked_up_at).toLocaleString('zh-TW')}</div>` : ''}
                  ${p.notes ? `<div class="muted">å‚™è¨»: ${p.notes}</div>` : ''}
                </div>
                <div class="package-status ${p.status==='picked-up'?'picked-up':'pending'}">
                  ${p.status==='picked-up'?'å·²é ˜å–':'å¾…é ˜å–'}
                </div>
              </div>
            `).join('')}
          </div>
        ` || '<div class="muted">æš«ç„¡åŒ…è£¹</div>';
      }catch(e){
        console.error(e);
        el.innerHTML = '<div class="muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function loadFinance(){
      const el=document.getElementById('financeSection');
      try{
        const { data, error } = await supabase.from('fees').select('room,amount,due,paid').order('due',{ascending:true}).limit(10);
        if (error) throw error;
        el.innerHTML = (data||[]).map(f=>`<div class="announcement-item"><div class="announcement-title">æˆ¿è™Ÿ ${f.room}</div><div class="muted">é‡‘é¡:$${f.amount}ã€€åˆ°æœŸæ—¥:${new Date(f.due).toLocaleDateString('zh-TW')}</div><div class="announcement-meta"><span>ç‹€æ…‹:${f.paid?'å·²ç¹³':'æœªç¹³'}</span></div></div>`).join('') || '<div class="announcement-item">æš«ç„¡è²¡å‹™ç´€éŒ„</div>';
      }catch(e){ console.error(e); el.innerHTML='<div class="announcement-item">è²¡å‹™è³‡æ–™è¼‰å…¥å¤±æ•—</div>'; }
    }

    async function loadVisitors(){
      const el=document.getElementById('visitorsSection');
      try{
        const { data, error } = await supabase.from('visitors').select('name,room,in,out').order('created_at',{ascending:false}).limit(10);
        if (error) throw error;
        el.innerHTML = (data||[]).map(v=>`<div class="announcement-item"><div class="announcement-title">${v.name} (æˆ¿è™Ÿ:${v.room})</div><div class="muted">é€²å…¥:${new Date(v.in).toLocaleString('zh-TW')} / é›¢é–‹:${v.out?new Date(v.out).toLocaleString('zh-TW'):'-'}</div></div>`).join('') || '<div class="announcement-item">æš«ç„¡è¨ªå®¢ç´€éŒ„</div>';
      }catch(e){ console.error(e); el.innerHTML='<div class="announcement-item">è¨ªå®¢è³‡æ–™è¼‰å…¥å¤±æ•—</div>'; }
    }

    async function loadMeetings(){
      const el=document.getElementById('meetingsSection');
      try{
        const { data, error } = await supabase.from('meetings').select('topic,time,location,notes').order('time',{ascending:false}).limit(10);
        if (error) throw error;
        el.innerHTML = (data||[]).map(m=>`<div class="announcement-item"><div class="announcement-title">${m.topic}</div><div class="muted">${m.notes||''}</div><div class="announcement-meta"><span>åœ°é»:${m.location}</span><span>${new Date(m.time).toLocaleString('zh-TW')}</span></div></div>`).join('') || '<div class="announcement-item">æš«ç„¡æœƒè­°è³‡æ–™</div>';
      }catch(e){ console.error(e); el.innerHTML='<div class="announcement-item">æœƒè­°è³‡æ–™è¼‰å…¥å¤±æ•—</div>'; }
    }

    async function loadEmergencies(){
      const el=document.getElementById('emergenciesSection');
      try{
        const { data, error } = await supabase.from('emergencies').select('type,time,by,note').order('time',{ascending:false}).limit(20);
        if (error) throw error;
        el.innerHTML = (data||[]).map(x=>`<div class="announcement-item"><div class="announcement-title">${x.type}</div><div class="muted">${x.note||''}</div><div class="announcement-meta"><span>ä½¿ç”¨è€…:${x.by||'-'}</span><span>${new Date(x.time).toLocaleString('zh-TW')}</span></div></div>`).join('') || '<div class="announcement-item">æš«ç„¡ç·Šæ€¥ç´€éŒ„</div>';
      }catch(e){ console.error(e); el.innerHTML='<div class="announcement-item">ç·Šæ€¥è³‡æ–™è¼‰å…¥å¤±æ•—</div>'; }
    }

    function confirmEmergency(type, note){
      if (confirm(`ç¢ºå®šè¦é€å‡ºã€Œ${type}ã€äº‹ä»¶å—ï¼Ÿ`)) {
        triggerEmergency(type, note);
      }
    }

    async function triggerEmergency(type, note){
      if (!currentUser){ alert("å°šæœªç™»å…¥"); return; }
      try{
        const payload = {
          type: type,
          note: note,
          time: new Date().toISOString(),
          ["by"]: currentUser.name || 'æœªçŸ¥'
        };

        const { data, error } = await supabase.from('emergencies').insert([payload]).select();
        if (error) {
          console.error("Supabase insert error:", error);
          alert("é€å‡ºå¤±æ•—ï¼š" + error.message);
          return;
        }

        if (data && data.length > 0){
          const x = data[0];
          const el = document.getElementById('emergencyList');
          const item = `
            <div class="announcement-item" style="border-left:4px solid #f44336;">
              <div class="announcement-title" style="color:#f44336;font-weight:bold">${x.type}</div>
              <div class="muted">${x.note||''}</div>
              <div class="announcement-meta">
                <span>ä½¿ç”¨è€…:${x.by||'-'}</span>
                <span>${new Date(x.time).toLocaleString('zh-TW')}</span>
              </div>
            </div>
          `;
          if (el) el.innerHTML = item + el.innerHTML;
        }
      }catch(e){
        console.error("triggerEmergency exception:", e);
        alert("é€å‡ºå¤±æ•—ï¼š" + e.message);
      }
    }

    function toggleAIChat(){
      const modal = document.getElementById('aiChatModal');
      modal.classList.toggle('active');
    }

    function switchAITab(tab){
      document.querySelectorAll('.ai-chat-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.ai-chat-tab[data-tab="${tab}"]`).classList.add('active');
      
      document.getElementById('aiTabFunctions').classList.add('hidden');
      document.getElementById('aiTabResident').classList.add('hidden');
      document.getElementById('aiTabEmergency').classList.add('hidden');
      document.getElementById('aiChatInputArea').style.display = 'none';
      
      if (tab === 'functions') {
        document.getElementById('aiTabFunctions').classList.remove('hidden');
      } else if (tab === 'resident') {
        document.getElementById('aiTabResident').classList.remove('hidden');
        document.getElementById('aiChatInputArea').style.display = 'flex';
      } else if (tab === 'emergency') {
        document.getElementById('aiTabEmergency').classList.remove('hidden');
      }
    }

    function navigateToSection(section){
      toggleAIChat();
      switchSection(section);
    }

    async function sendAIMessage(){
      const input = document.getElementById('aiChatInput');
      const message = input.value.trim();
      if (!message) return;

      const messagesContainer = document.getElementById('aiTabResident');
      
      // Add user message
      const userMsg = document.createElement('div');
      userMsg.className = 'ai-message user';
      userMsg.textContent = message;
      messagesContainer.appendChild(userMsg);
      
      input.value = '';
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Simple AI response based on keywords
      setTimeout(async () => {
        const botMsg = document.createElement('div');
        botMsg.className = 'ai-message bot';
        
        let response = await getAIResponse(message);
        botMsg.textContent = response;
        
        messagesContainer.appendChild(botMsg);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 500);
    }

    async function getAIResponse(message){
      const msg = message.toLowerCase();
      
      // Try to fetch from knowledge base
      try{
        const { data, error } = await supabase
          .from('knowledge')
          .select('content');
        
        if (!error && data) {
          for (let item of data) {
            const content = item.content.toLowerCase();
            if (msg.includes('å…¬å‘Š') && content.includes('å…¬å‘Š')) return item.content;
            if (msg.includes('æŠ•ç¥¨') && content.includes('æŠ•ç¥¨')) return item.content;
            if (msg.includes('ç¶­ä¿®') && content.includes('ç¶­ä¿®')) return item.content;
            if (msg.includes('åŒ…è£¹') && content.includes('åŒ…è£¹')) return item.content;
            if (msg.includes('ç®¡ç†è²»') && content.includes('ç®¡ç†è²»')) return item.content;
            if (msg.includes('åœè»Š') && content.includes('åœè»Š')) return item.content;
            if (msg.includes('é–€ç¦') && content.includes('é–€ç¦')) return item.content;
            if (msg.includes('åƒåœ¾') && content.includes('åƒåœ¾')) return item.content;
            if (msg.includes('å¯µç‰©') && content.includes('å¯µç‰©')) return item.content;
            if (msg.includes('è£ä¿®') && content.includes('è£ä¿®')) return item.content;
          }
        }
      }catch(e){
        console.error(e);
      }
      
      if (msg.includes('å…¬å‘Š')) {
        return 'æ‚¨å¯ä»¥åœ¨ã€Œå…¬å‘Šã€é é¢æŸ¥çœ‹æœ€æ–°å…¬å‘Šã€‚å…¬å‘Šæœƒä»¥è¼ªæ’­æ–¹å¼é¡¯ç¤ºåœ¨é¦–é ã€‚';
      }
      if (msg.includes('æŠ•ç¥¨')) {
        return 'æ‚¨å¯ä»¥åœ¨ã€ŒæŠ•ç¥¨ã€é é¢æŸ¥çœ‹æ‰€æœ‰æŠ•ç¥¨ä¸¦åƒèˆ‡æŠ•ç¥¨ã€‚æ¯å€‹æŠ•ç¥¨éƒ½æœƒé¡¯ç¤ºå³æ™‚çµ±è¨ˆçµæœã€‚';
      }
      if (msg.includes('ç¶­ä¿®') || msg.includes('å ±ä¿®')) {
        return 'æ‚¨å¯ä»¥åœ¨ã€Œè¨­å‚™/ç¶­è­·ã€é é¢æäº¤ç¶­ä¿®ç”³è«‹ï¼ŒåŒ…æ‹¬è¨­å‚™åç¨±ã€å•é¡Œæè¿°å’Œç…§ç‰‡ã€‚æäº¤å¾Œå¯ä»¥åœ¨ã€Œæˆ‘çš„ç¶­ä¿®ç”³è«‹ã€ä¸­æŸ¥çœ‹è™•ç†ç‹€æ…‹ã€‚';
      }
      if (msg.includes('åŒ…è£¹') || msg.includes('å¿«é')) {
        return 'æ‚¨å¯ä»¥åœ¨ã€Œæˆ‘çš„åŒ…è£¹ã€é é¢æŸ¥çœ‹åŒ…è£¹é ˜å–ç‹€æ³ï¼ŒåŒ…æ‹¬å¿«éå…¬å¸ã€è¿½è¹¤è™Ÿç¢¼å’Œåˆ°é”æ™‚é–“ã€‚';
      }
      if (msg.includes('ç®¡ç†è²»') || msg.includes('ç¹³è²»')) {
        return 'æ‚¨å¯ä»¥åœ¨ã€Œç®¡ç†è²»/æ”¶æ”¯ã€é é¢æŸ¥çœ‹ç¹³è²»ç‹€æ³ã€‚å¦‚æœ‰å•é¡Œè«‹è¯ç¹«ç®¡å§”æœƒã€‚';
      }
      if (msg.includes('å€‹äºº') || msg.includes('è³‡æ–™') || msg.includes('å¯†ç¢¼')) {
        return 'æ‚¨å¯ä»¥åœ¨ã€Œå€‹äººè³‡æ–™ã€é é¢ä¿®æ”¹å§“åã€æˆ¿è™Ÿã€é›»è©±ã€Email å’Œå¯†ç¢¼ã€‚';
      }
      
      return 'æŠ±æ­‰,æˆ‘é‚„åœ¨å­¸ç¿’ä¸­ã€‚æ‚¨å¯ä»¥è©¢å•é—œæ–¼å…¬å‘Šã€ç¶­ä¿®ã€ç¹³è²»ã€åŒ…è£¹ç­‰å•é¡Œï¼Œæˆ–ä½¿ç”¨ã€Œå¸¸ç”¨åŠŸèƒ½ã€å¿«é€Ÿå°èˆªã€‚';
    }

    function logout(){ localStorage.removeItem('currentUser'); window.location.href='index.html'; }
  </script>
</body>
</html>
